const NOTES_STORAGE_KEY="quick_notes";class NotesManager{constructor(){this.notes=this.loadNotes(),this.currentNoteId=null,this.init()}init(){this.bindEvents(),this.renderNotes()}bindEvents(){const t=document.getElementById("new-note-btn");t&&t.addEventListener("click",()=>this.createNewNote());const n=document.getElementById("save-note-btn");n&&n.addEventListener("click",()=>this.saveCurrentNote());const s=document.getElementById("cancel-note-btn");s&&s.addEventListener("click",()=>this.cancelEdit());const o=document.getElementById("delete-note-btn");o&&o.addEventListener("click",()=>this.deleteCurrentNote());const i=document.getElementById("clear-all-btn");i&&i.addEventListener("click",()=>this.clearAllNotes());const a=document.getElementById("search-notes");a&&a.addEventListener("input",e=>this.searchNotes(e.target.value));const r=document.getElementById("export-note-btn");r&&r.addEventListener("click",e=>{e.stopPropagation(),this.exportSingleNote()});const c=document.getElementById("export-all-btn");c&&c.addEventListener("click",()=>this.exportAllNotes());const l=document.getElementById("import-btn"),e=document.getElementById("import-file");l&&e&&(l.addEventListener("click",()=>e.click()),e.addEventListener("change",e=>this.importNotes(e))),document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.key==="s"){e.preventDefault();const n=document.getElementById("note-editor"),t=document.querySelector(".note-card.editing");if(t){const s=t.getAttribute("data-id"),e=t.querySelector(".note-title-input-inline"),n=t.querySelector(".note-content-input-inline");e&&n&&this.saveInlineNote(s,e.value,n.value)}else n&&!n.classList.contains("hidden")&&this.saveCurrentNote()}})}loadNotes(){try{const e=localStorage.getItem(NOTES_STORAGE_KEY);if(e){const t=JSON.parse(e);return t.sort((e,t)=>new Date(t.updatedAt)-new Date(e.updatedAt))}}catch(e){console.error("Load notes failed:",e)}return[]}saveNotes(){try{localStorage.setItem(NOTES_STORAGE_KEY,JSON.stringify(this.notes))}catch(e){console.error("Save notes failed:",e),alert("Save failed, maybe the storage space is full")}}createNewNote(){this.currentNoteId&&this.cancelInlineEdit(),this.currentNoteId=null;const n=document.getElementById("note-editor"),e=document.getElementById("note-title"),s=document.getElementById("note-content"),o=document.getElementById("note-date"),i=document.getElementById("delete-note-btn"),t=document.getElementById("export-note-btn");n.classList.remove("hidden"),e.value="",s.value="",o.textContent="",i.classList.add("hidden"),t&&t.classList.add("hidden"),setTimeout(()=>e.focus(),100)}editNote(e){const n=this.notes.find(t=>t.id===e);if(!n)return;this.currentNoteId&&this.currentNoteId!==e&&this.cancelInlineEdit(),this.currentNoteId=e;const t=document.querySelector(`.note-card[data-id="${e}"]`);if(!t||t.classList.contains("editing"))return;const o=n.title,i=n.content,a=this.formatDate(n.createdAt),r=this.formatDate(n.updatedAt);t.classList.add("editing"),t.innerHTML=`
            <div class="note-editor-inline">
                <div class="editor-header">
                    <input type="text" class="note-title-input-inline" value="${this.escapeHtml(o)}" placeholder="Title">
                    <div class="editor-actions">
                        <button class="btn btn-save-inline">Save</button>
                        <button class="btn btn-cancel-inline">Cancel</button>
                    </div>
                </div>
                <textarea class="note-content-input-inline" placeholder="Write your notes here...">${this.escapeHtml(i)}</textarea>
                <div class="note-meta">
                    <span class="note-date">Created: ${a} | Updated: ${r}</span>
                    <div class="note-actions">
                        <button class="btn btn-export-inline">Export</button>
                        <button class="btn btn-delete-inline">Delete</button>
                    </div>
                </div>
            </div>
        `;const c=t.querySelector(".btn-save-inline"),l=t.querySelector(".btn-cancel-inline"),d=t.querySelector(".btn-delete-inline"),u=t.querySelector(".btn-export-inline"),h=t.querySelector(".note-title-input-inline"),s=t.querySelector(".note-content-input-inline");c.addEventListener("click",t=>{t.stopPropagation(),this.saveInlineNote(e,h.value,s.value)}),l.addEventListener("click",e=>{e.stopPropagation(),this.cancelInlineEdit()}),d.addEventListener("click",t=>{t.stopPropagation(),confirm("Are you sure you want to delete this note?")&&(this.notes=this.notes.filter(t=>t.id!==e),this.saveNotes(),this.renderNotes(),this.currentNoteId=null)}),u.addEventListener("click",t=>{t.stopPropagation(),this.exportNoteById(e)}),t.addEventListener("click",e=>e.stopPropagation()),setTimeout(()=>s.focus(),100)}saveCurrentNote(){const s=document.getElementById("note-title"),o=document.getElementById("note-content"),e=s.value.trim(),t=o.value.trim();if(!e&&!t){alert("Title and content cannot be empty");return}const n=(new Date).toISOString();if(this.currentNoteId){const s=this.notes.find(e=>e.id===this.currentNoteId);s&&(s.title=e||"No title",s.content=t,s.updatedAt=n)}else{const s={id:Date.now().toString(),title:e||"No title",content:t,createdAt:n,updatedAt:n};this.notes.unshift(s)}this.notes.sort((e,t)=>new Date(t.updatedAt)-new Date(e.updatedAt)),this.saveNotes(),this.renderNotes(),this.cancelEdit()}saveInlineNote(e,t,n){const o=t.trim(),i=n.trim();if(!o&&!i){alert("标题和内容不能同时为空");return}const s=this.notes.find(t=>t.id===e);s&&(s.title=o||"No title",s.content=i,s.updatedAt=(new Date).toISOString()),this.notes.sort((e,t)=>new Date(t.updatedAt)-new Date(e.updatedAt)),this.saveNotes(),this.currentNoteId=null,this.renderNotes()}cancelInlineEdit(){if(!this.currentNoteId)return;this.currentNoteId=null,this.renderNotes()}exportNoteById(e){const t=this.notes.find(t=>t.id===e);if(!t)return;const n=this.noteToMarkdown(t),s=this.sanitizeFilename(t.title)+".md";this.downloadFile(n,s,"text/markdown")}deleteCurrentNote(){if(!this.currentNoteId)return;confirm("Are you sure you want to delete this note?")&&(this.notes=this.notes.filter(e=>e.id!==this.currentNoteId),this.saveNotes(),this.renderNotes(),this.cancelEdit())}cancelEdit(){const t=document.getElementById("note-editor"),e=document.getElementById("export-note-btn");t.classList.add("hidden"),this.currentNoteId=null,e&&e.classList.add("hidden")}clearAllNotes(){confirm("Are you sure you want to clear all notes? This action cannot be undone!")&&(this.notes=[],this.saveNotes(),this.renderNotes(),this.cancelEdit())}searchNotes(e){const t=e.toLowerCase().trim(),n=document.querySelectorAll(".note-card");if(!t){n.forEach(e=>e.classList.remove("hidden"));return}n.forEach(e=>{const s=e.getAttribute("data-id"),n=this.notes.find(e=>e.id===s);if(!n){e.classList.add("hidden");return}const o=n.title.toLowerCase(),i=n.content.toLowerCase();o.includes(t)||i.includes(t)?e.classList.remove("hidden"):e.classList.add("hidden")})}renderNotes(){const e=document.getElementById("notes-list"),t=document.getElementById("empty-state");if(!e)return;if(this.notes.length===0){e.innerHTML="",t&&t.classList.remove("hidden");return}t&&t.classList.add("hidden");const n=new Set;e.querySelectorAll(".note-card.expanded").forEach(e=>{const t=e.getAttribute("data-id");t&&n.add(t)}),e.innerHTML=this.notes.map(e=>{const s=e.content.length>300,t=n.has(e.id),o=s&&!t?e.content.substring(0,300)+"...":e.content;return`
                <div class="note-card ${t?"expanded":""}" data-id="${e.id}">
                    <div class="note-card-header">
                        <h3 class="note-card-title">${this.escapeHtml(e.title)}</h3>
                        <span class="note-card-date">${this.formatDate(e.updatedAt)}</span>
                    </div>
                    <div class="note-card-content ${s&&!t?"collapsed":""}">${this.escapeHtml(o)}</div>
                    ${s?`
                        <button class="note-toggle-btn" data-id="${e.id}">
                            <span class="toggle-text">${t?"收起":"展开"}</span>
                        </button>
                    `:""}
                </div>
            `}).join(""),e.querySelectorAll(".note-toggle-btn").forEach(e=>{e.addEventListener("click",t=>{t.stopPropagation();const i=e.getAttribute("data-id"),n=document.querySelector(`.note-card[data-id="${i}"]`);if(!n)return;const r=n.classList.contains("expanded"),s=this.notes.find(e=>e.id===i);if(!s)return;const o=n.querySelector(".note-card-content"),a=e.querySelector(".toggle-text");if(r){n.classList.remove("expanded"),o.classList.add("collapsed");const e=s.content.length>300?s.content.substring(0,300)+"...":s.content;o.innerHTML=this.escapeHtml(e),a.textContent="展开"}else n.classList.add("expanded"),o.classList.remove("collapsed"),o.innerHTML=this.escapeHtml(s.content),a.textContent="收起"})}),e.querySelectorAll(".note-card").forEach(e=>{e.addEventListener("click",t=>{if(t.target.closest(".note-toggle-btn"))return;const n=e.getAttribute("data-id");this.editNote(n)})})}formatDate(e){const s=new Date(e),a=new Date,t=a-s,n=Math.floor(t/6e4),o=Math.floor(t/36e5),i=Math.floor(t/864e5);return n<1?"just now":n<60?`${n} minutes ago`:o<24?`${o} hours ago`:i<7?`${i} days ago`:s.toLocaleDateString("zh-CN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}exportSingleNote(){if(!this.currentNoteId)return;const e=this.notes.find(e=>e.id===this.currentNoteId);if(!e)return;const t=this.noteToMarkdown(e),n=this.sanitizeFilename(e.title)+".md";this.downloadFile(t,n,"text/markdown")}exportAllNotes(){if(this.notes.length===0){alert("No notes to export");return}this.notes.forEach((e,t)=>{const n=this.noteToMarkdown(e),s=this.sanitizeFilename(e.title)+".md";setTimeout(()=>{this.downloadFile(n,s,"text/markdown")},t*300)}),setTimeout(()=>{alert(`Exporting ${this.notes.length} notes as separate MD files...`)},100)}noteToMarkdown(e){const t=new Date(e.createdAt).toLocaleString("zh-CN"),n=new Date(e.updatedAt).toLocaleString("zh-CN");return`---
title: "${e.title}"
created: ${t}
updated: ${n}
---

${e.content}`}importNotes(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=e=>{try{const n=e.target.result,s=t.name.toLowerCase();if(s.endsWith(".json")){const e=JSON.parse(n);Array.isArray(e)?this.mergeNotes(e):alert("JSON format is incorrect, should be an array of notes")}else if(s.endsWith(".md")){{const e=this.markdownToNote(n,t.name);if(e){const t=this.notes.some(t=>t.title===e.title&&Math.abs(new Date(t.createdAt)-new Date(e.createdAt))<1e3);t?confirm("Similar notes found, do you still want to import? (will create a new note)")&&(e.id=Date.now().toString(),e.createdAt=(new Date).toISOString(),e.updatedAt=(new Date).toISOString(),this.notes.unshift(e),this.saveNotes(),this.renderNotes(),alert("Notes imported successfully!")):(this.notes.unshift(e),this.saveNotes(),this.renderNotes(),alert("Notes imported successfully!"))}}}else alert("Unsupported file format, please use .md or .json files")}catch(e){console.error("Import failed:",e),alert("Import failed: "+e.message)}},n.readAsText(t),e.target.value=""}markdownToNote(e,t){try{const r=/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/,o=e.match(r);let n="Imported notes",i=(new Date).toISOString(),a=(new Date).toISOString(),s=e;if(o){{const e=o[1];s=o[2];const t=e.match(/title:\s*["']?(.+?)["']?$/m),r=e.match(/created:\s*(.+?)$/m),c=e.match(/updated:\s*(.+?)$/m);if(t&&(n=t[1].trim()),r)try{i=new Date(r[1].trim()).toISOString()}catch{}if(c)try{a=new Date(c[1].trim()).toISOString()}catch{a=i}}}else{const o=e.trim().split(`
`);if(o.length>0&&o[0].trim()){const e=o[0].trim();e.startsWith("# ")?(n=e.substring(2).trim(),s=o.slice(1).join(`
`)):e.length<100&&!e.includes(`
`)?(n=e,s=o.slice(1).join(`
`)):n=t.replace(/\.md$/i,"").trim()||"Imported notes"}}return{id:Date.now().toString(),title:n||"Imported notes",content:s.trim(),createdAt:i,updatedAt:a}}catch(e){return console.error("Parse Markdown failed:",e),alert("Parse file failed: "+e.message),null}}mergeNotes(e){let t=0;e.forEach(e=>{const n=this.notes.some(t=>t.id===e.id);n||(this.notes.push(e),t++)}),t>0?(this.notes.sort((e,t)=>new Date(t.updatedAt)-new Date(e.updatedAt)),this.saveNotes(),this.renderNotes(),alert(`Successfully imported ${t} notes`)):alert("No new notes to import")}downloadFile(e,t,n){const i=new Blob([e],{type:n}),o=URL.createObjectURL(i),s=document.createElement("a");s.href=o,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}sanitizeFilename(e){return e.replace(/[<>:"/\\|?*]/g,"-").replace(/\s+/g,"-").substring(0,100).replace(/^-+|-+$/g,"")||"note"}}function initNotesManager(){document.getElementById("notes-list")&&new NotesManager}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",initNotesManager):initNotesManager()